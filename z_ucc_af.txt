z_ucc_af1:--z_ucc_af1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
declare @tmp table(
	gno nvarchar(10),
	custno nvarchar(35),
	custs nvarchar(90),
	mainsno nvarchar(35),
	storeno nvarchar(35),
	stores nvarchar(90),
	productno nvarchar(50),
	products nvarchar(90),
	unit nvarchar(12),
	mount float
)
insert into @tmp
	select
		a.gno,a.custno,c.nick,isnull(b.noa,''),a.storeno,isnull(b.store,''),a.productno,a.product,a.unit,sum(a.mount)
	from (
		select
			'0' gno,b.custno,a.storeno,a.productno,a.product,a.unit,sum(a.mount)*(-1) mount
		from view_vccs a
		left join view_vcc b on a.noa= b.noa
		where (b.datea between @t_bdate and @t_edate)
		group by b.custno,a.storeno,a.productno,a.product,a.unit
		union
		select
			'0' gno,a.custno,b.storeno,b.productno,b.product,b.unit,sum(b.mount) mount
		from view_ina a 
		left join view_inas b on a.noa = b.noa
		where (a.datea between @t_bdate and @t_edate)
		group by a.custno,b.storeno,b.productno,b.product,b.unit
		union
		select
			'0' gno,a.custno,a.storeno,b.productno,b.product,b.unit,sum(b.mount)*(-1) mount ------調出倉庫
		from view_cng a 
		left join view_cngs b on a.noa = b.noa
		where (a.datea between @t_bdate and @t_edate)
		group by a.custno,a.storeno,b.productno,b.product,b.unit
		union
		select
			'0' gno,a.custno,a.storeinno,b.productno,b.product,b.unit,sum(b.mount) mount ------調入倉庫
		from view_cng a 
		left join view_cngs b on a.noa = b.noa
		where (a.datea between @t_bdate and @t_edate)
		group by a.custno,a.storeinno,b.productno,b.product,b.unit
	) a 
	left join store b on left(a.storeno,len(b.noa))=b.noa
	left join cust c on a.custno = c.noa
	group by a.gno,a.custno,c.nick,isnull(b.noa,''),a.storeno,isnull(b.store,''),a.productno,a.product,a.unit
select * from @tmp order by mainsno,gno,storeno;
---------------------------------*****************-------------------------------------------
z_ucc_af2:--z_ucc_af2
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
declare @tmp table(
	gno nvarchar(1),
	orderby int,
	typea nvarchar(15),
	noa nvarchar(50),
	storeno nvarchar(30),
	custno nvarchar(50),
	custs nvarchar(90),
	productno nvarchar(50),
	products nvarchar(90),
	unit nvarchar(15),
	inmount float,
	outmount float,
	total float,
	qhref nvarchar(max)
)
---------------期初數量<Start>
insert into @tmp
	select
		a.gno,0,a.typea,a.noa,a.storeno,a.custno,b.nick,a.productno,a.product,a.unit,sum(inmount),sum(outmount),0,'' qhref
	from (
		select
			'1' gno,'期初' typea,'期初數量' noa,b.storeno,a.custno,b.productno,b.product,b.unit,
			case a.typea when '2' then 0 else b.mount end inmount,
			case a.typea when '2' then b.mount else 0 end outmount
		from view_vcc a
		left join view_vccs b on a.noa=b.noa
		outer apply(select count(*) mount from view_vccs where noa=a.noa) c
		where (a.datea < @t_bdate) and (c.mount > 0)
		union
		select
			'1' gno,'期初' typea,'期初數量' noa,b.storeno,a.custno,b.productno,b.product,b.unit,
			b.mount inmount,0 outmount
		from view_ina a
		left join view_inas b on a.noa=b.noa
		outer apply(select count(*) mount from view_inas where noa=a.noa) c
		where (a.datea < @t_bdate) and (c.mount > 0)
		union
		select
			'1' gno,'期初' typea,'期初數量' noa,a.storeno,a.custno,b.productno,b.product,b.unit,
			0 inmount,b.mount outmount
		from view_cng a
		left join view_cngs b on a.noa=b.noa
		outer apply(select count(*) mount from view_cngs where noa=a.noa) c
		where (a.datea < @t_bdate) and (c.mount > 0)
		union
		select
			'1' gno,'期初' typea,'期初數量' noa,a.storeinno,a.custno,b.productno,b.product,b.unit,
			b.mount inmount,0 outmount
		from view_cng a
		left join view_cngs b on a.noa=b.noa
		outer apply(select count(*) mount from view_cngs where noa=a.noa) c
		where (a.datea < @t_bdate) and (c.mount > 0)
	) a
	left join cust b on a.custno=b.noa
	group by a.gno,a.typea,a.noa,a.storeno,a.custno,b.nick,a.productno,a.product,a.unit
---------------期初數量<End>
insert into @tmp
	select
		a.gno,1,a.typea,a.noa,a.storeno,a.custno,b.nick,a.productno,a.product,a.unit,inmount,outmount,0,a.qhref
	from (
		select
			'0' gno,case a.typea when '2' then '退貨' else '進貨' end typea,
			a.noa,b.storeno,a.custno,b.productno,b.product,b.unit,
			case a.typea when '2' then 0 else b.mount end inmount,
			case a.typea when '2' then b.mount else 0 end outmount,'vcc' qhref
		from view_vcc a
		left join view_vccs b on a.noa=b.noa
		outer apply(select count(*) mount from view_vccs where noa=a.noa) c
		where (a.datea between @t_bdate and @t_edate) and (c.mount > 0)
		union
		select
			'0' gno,'入庫' typea,a.noa,b.storeno,a.custno,b.productno,b.product,b.unit,
			b.mount inmount,0 outmount,'ina' qhref
		from view_ina a
		left join view_inas b on a.noa=b.noa
		outer apply(select count(*) mount from view_inas where noa=a.noa) c
		where (a.datea between @t_bdate and @t_edate) and (c.mount > 0)
		union
		select
			'0' gno,'調出' typea,a.noa,a.storeno,a.custno,b.productno,b.product,b.unit,
			0 inmount,b.mount outmount,'cng' qhref
		from view_cng a
		left join view_cngs b on a.noa=b.noa
		outer apply(select count(*) mount from view_cngs where noa=a.noa) c
		where (a.datea between @t_bdate and @t_edate) and (c.mount > 0)
		union
		select
			'0' gno,'調入' typea,a.noa,a.storeinno,a.custno,b.productno,b.product,b.unit,
			b.mount inmount,0 outmount,'cng' qhref
		from view_cng a
		left join view_cngs b on a.noa=b.noa
		outer apply(select count(*) mount from view_cngs where noa=a.noa) c
		where (a.datea between @t_bdate and @t_edate) and (c.mount > 0)
	) a
	left join cust b on a.custno=b.noa
insert into @tmp
	select
		'1' gno,0 orderby,'期初' typea,'期初數量' noa,a.storeno,a.custno,a.custs,
		a.productno,a.products,a.unit,0 inmount,0 outmount,0 total,'' qhref
	from @tmp a
	outer apply(select count(*) mount from @tmp where (orderby=0) and (storeno=a.storeno) and (custno=a.custno) and (productno=a.productno) and (unit=a.unit)) b
	where isnull(b.mount,0)=0
	group by a.storeno,a.custno,a.custs,a.productno,a.products,a.unit
insert into @tmp(gno,orderby,storeno,custno,custs,productno,products,unit,inmount,outmount)
	select
		'2',999,storeno,custno,custs,productno,products,unit,sum(inmount),sum(outmount)
	from @tmp where gno='0' or gno='1'
	group by storeno,custno,custs,productno,products,unit
update @tmp set total=inmount-outmount where gno='2' or gno='1'
select
	a.gno,a.orderby,a.typea,a.noa,a.storeno,a.custno,a.custs,a.productno,a.products,a.unit,
	a.inmount,
	a.outmount,
	case when (a.total=0) and (a.gno='0') then null else a.total end total,
	case when len(qhref)>0 then a.qhref+'_af?left(noa,'+cast(len(a.noa) as nvarchar)+')=$noa?' else '' end qhref
from @tmp a order by a.storeno,a.custno,a.productno,a.unit,a.orderby,a.typea;